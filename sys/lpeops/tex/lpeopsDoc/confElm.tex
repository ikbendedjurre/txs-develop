\chapter{confelm}

\section{Introduction}
One way in which information about confluence can be used before state space generation, is by appending confluent ISTEPs to other summands.
This has the effect that other branches that could follow those summands are ignored, reducing the size of the state space while maintaining its equivalence up to branching bisimulation.

\section{Theoretical background}

\subsection{Definite successors}

Consider all possible pairs of summands of the LPE (including symmetric pairs).
Of a given summand pair $(s, t)$, let $t$ be a \emph{definite successor} of $s$ if the following expression is a tautology:
\begin{align*}
c_s \land {c_t}[p \rightarrow v_s(p) \;|\; p \in P]
\end{align*}

where

\begin{itemize}
\item $c_s$ and $c_t$ are the guards of summands $s$ and $t$, respectively;
\item $P$ is the set of all LPE parameters;
\item $v_s(p)$ is the expression that defines the new value of LPE parameter $p$ after the application of summand $s$.
\end{itemize}

\section{Implementation}

For each summand $s$, let $D(s)$ be the set of all definite successors of $s$.
By definition, $D(s)$ is an under-approximation of the actual successors of $s$.

The algorithm follows these steps:

\begin{enumerate}

\item Determine which \istep{} summands of the LPE are confluent (see \ref{confcheck}).
Rename the \istep{} channels in confluent \istep{} summands to \cistep{}.

\item For each summand $s_1$, determine $D(s_1)$.
Check if there exists a summand $s_2 \in D(s_1)$ such that $s_2$ communicates over the \cistep{} channel.
If so, let
\begin{align*}
s_i = C_i \; \texttt{?} \; x_i(1) \; \cdots{} \; \texttt{?} \; x_i(m_i) \; [[g_i]] \; \texttt{>->} \; P(v_i(p_1), \cdots{}, v_i(p_k))
\end{align*}

where

\begin{itemize}
\item $C_1$ is the name of the channel over which summand $s_1$ communicates;
\item $C_2$ equals $\cistep{}$;
\item $m_i \geq 0$ is the number of variables that summand $s_i$ uses to communicate over channel $C_i$;
\item $x_i(j)$ is the variable that summand $s_i$ uses to communicate the $j$th value of channel $C_i$;
\item $g_i$ is the guard of summand $s_i$ (the only free variables in this expression must be LPE parameters or communication variables of summand $s_i$);
\item $P$ is the LPE to which summand $s_i$ belongs;
\item $p_1, \cdots{}, p_k$ are the parameters of the LPE, of which there are $k \geq 0$;
\item $v_i(p)$ is an expression that defines the new value of LPE parameter $p$ after the application of summand $s_i$ (the only free variables in this expression must be LPE parameters or communication variables of summand $s_i$).
\end{itemize}

Furthermore, let
\begin{align*}
X = [ x_2(j) \rightarrow q(x_2(j)) \;|\; 1 \leq j \leq m_2 ]
\end{align*}

where $q(x)$ is a surjective function that yields fresh variables, and let
\begin{align*}
V_{1} &= [p_j \rightarrow v_1(p_j) \;|\; 1 \leq j \leq k]
\end{align*}

\item Replace $s_1$ by ${s_1}'$, which is defined as
\begin{align*}
{s_1}' = C_1 \; &\texttt{?} \; x_1(1) \; \cdots{} \; \texttt{?} \; x_1(m_1) \\
&\texttt{?} \; x_2(1)[X] \; \cdots{} \; \texttt{?} \; x_2(m_2)[X] \\
&[[g_1]] \; \texttt{>->} \; P(v_2(p_1)[X][V_1], \cdots{}, v_2(p_k)[X][V_1])
\end{align*}

\end{enumerate}

\clearpage
\section{Example TOCHECK}

Consider the following example:

\begin{lstlisting}
//Process definition:
PROCDEF example[A :: Int](x, y :: Int)
  = A >-> example[A]((x+1) mod 3, y)
  + ISTEP >-> example[A](x, (y+1) mod 4)
  ;

//Initialization:
example[A](0, 0);
\end{lstlisting}

The second summand is a confluent ISTEP summand.
It is also a definite successor of the first summand.
This means that the second summand can be appended to the first summand.

The second summand is also a definite successor of itself.
This means that the second summand can also be appended to itself.

Therefore, the original process can be changed to

\begin{lstlisting}
//Process definition:
PROCDEF example[A :: Int](x, y :: Int)
  = A >-> example[A]((x+1) mod 3, (y+1) mod 4)
  + ISTEP >-> example[A](x, (((y+1) mod 4)+1) mod 4)
  ;

//Initialization:
example[A](0, 0);
\end{lstlisting}


